<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS to Social Poster</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Automated RSS to Social Media Poster</h1>
        <p class="text-gray-600 text-center mb-8">Post your favorite RSS feed items to Mastodon and Bluesky. Simply enter your credentials and feed URL below!</p>

        <div id="messageBox" class="hidden mb-4 p-4 rounded-lg text-center font-medium transition-opacity duration-300"></div>

        <div class="space-y-6">
            <!-- Mastodon Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Mastodon Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="mastodon-server" class="block text-sm font-medium text-gray-700">Mastodon Server URL (e.g., https://mastodon.social)</label>
                        <input type="text" id="mastodon-server" placeholder="https://your-mastodon-instance.social" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="mastodon-token" class="block text-sm font-medium text-gray-700">Mastodon API Token</label>
                        <input type="password" id="mastodon-token" placeholder="Enter your Mastodon API token" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <!-- Bluesky Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Bluesky Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="bluesky-identifier" class="block text-sm font-medium text-gray-700">Bluesky Handle or Email</label>
                        <input type="text" id="bluesky-identifier" placeholder="yourhandle.bsky.social or your@email.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="bluesky-password" class="block text-sm font-medium text-gray-700">Bluesky App Password</label>
                        <input type="password" id="bluesky-password" placeholder="Enter your Bluesky App Password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <!-- RSS Feed Section -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">RSS Feed URL</h2>
                <input type="text" id="rss-url" placeholder="Add RSS URL, e.g., https://www.nasa.gov/news/feed/" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4">
                <button id="test-connection-btn" class="w-1/2 flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">Test Connections</button>
                <button id="post-btn" class="w-1/2 flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">Fetch & Post to Social Media</button>
            </div>
        </div>
    </div>

    <script>
        const mastodonServerInput = document.getElementById('mastodon-server');
        const mastodonTokenInput = document.getElementById('mastodon-token');
        const blueskyIdentifierInput = document.getElementById('bluesky-identifier');
        const blueskyPasswordInput = document.getElementById('bluesky-password');
        const rssUrlInput = document.getElementById('rss-url');
        const testBtn = document.getElementById('test-connection-btn');
        const postBtn = document.getElementById('post-btn');
        const messageBox = document.getElementById('messageBox');
        
        // --- Utility Functions ---

        /**
         * Fetches an RSS feed using a CORS proxy.
         * @param {string} url The URL of the RSS feed.
         * @returns {Promise<Document>} The parsed XML document.
         */
        async function fetchRssFeed(url) {
            try {
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(corsProxy + encodeURIComponent(url));
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const parser = new DOMParser();
                return parser.parseFromString(text, "text/xml");
            } catch (error) {
                showMessage(`Error fetching RSS feed: ${error.message}`, 'bg-red-500 text-white');
                return null;
            }
        }

        /**
         * Displays a temporary message in the message box.
         * @param {string} message The message to display.
         * @param {string} type The Tailwind CSS classes for styling (e.g., 'bg-green-500 text-white').
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `block mb-4 p-4 rounded-lg text-center font-medium transition-opacity duration-300 ${type}`;
            messageBox.style.opacity = '1';
            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.className = 'hidden';
                }, 300);
            }, 5000);
        }

        // --- Mastodon Functions ---

        /**
         * Posts a status to Mastodon.
         * @param {string} serverUrl The Mastodon instance URL.
         * @param {string} token The API token.
         * @param {string} status The content of the post.
         * @returns {Promise<boolean>} True if successful, false otherwise.
         */
        async function postToMastodon(serverUrl, token, status) {
            try {
                const response = await fetch(`${serverUrl}/api/v1/statuses`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                return response.ok;
            } catch (error) {
                console.error('Mastodon post error:', error);
                return false;
            }
        }

        // --- Bluesky Functions ---

        /**
         * Creates a session with the Bluesky API.
         * @param {string} identifier The user's handle or email.
         * @param {string} password The app password.
         * @returns {Promise<object>} The session object or null on failure.
         */
        async function createBlueskySession(identifier, password) {
            try {
                const response = await fetch('https://bsky.social/xrpc/com.atproto.server.createSession', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });
                if (!response.ok) {
                    throw new Error(`Bluesky session creation failed: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Bluesky session error:', error);
                return null;
            }
        }

        /**
         * Posts a feed item to Bluesky.
         * @param {string} text The content of the post.
         * @param {string} accessJwt The access token for the session.
         * @returns {Promise<boolean>} True if successful, false otherwise.
         */
        async function postToBluesky(text, accessJwt) {
            try {
                const response = await fetch('https://bsky.social/xrpc/com.atproto.repo.createRecord', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessJwt}`
                    },
                    body: JSON.stringify({
                        repo: 'me', // 'me' is a special value that resolves to the authenticated user's DID
                        collection: 'app.bsky.feed.post',
                        record: {
                            text,
                            createdAt: new Date().toISOString(),
                            $type: 'app.bsky.feed.post'
                        }
                    })
                });
                return response.ok;
            } catch (error) {
                console.error('Bluesky post error:', error);
                return false;
            }
        }
        
        // --- Main Logic ---

        testBtn.addEventListener('click', async () => {
            const mastodonServer = mastodonServerInput.value.trim();
            const mastodonToken = mastodonTokenInput.value.trim();
            const blueskyIdentifier = blueskyIdentifierInput.value.trim();
            const blueskyPassword = blueskyPasswordInput.value.trim();
            const rssUrl = rssUrlInput.value.trim();

            if (!mastodonServer && !blueskyIdentifier && !rssUrl) {
                showMessage('Please enter at least one URL or credential to test.', 'bg-yellow-500 text-white');
                return;
            }

            let mastodonSuccess = false;
            if (mastodonServer && mastodonToken) {
                showMessage('Testing Mastodon connection...', 'bg-blue-500 text-white');
                // The most reliable way to test a Mastodon token is to try posting something.
                // We'll post a private, unlisted status.
                const testStatus = 'This is a test post from my RSS reader app.';
                const response = await fetch(`${mastodonServer}/api/v1/statuses`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${mastodonToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: testStatus,
                        visibility: 'unlisted' // Unlisted so it doesn't appear on public timelines
                    })
                });
                if (response.ok) {
                    mastodonSuccess = true;
                    // Delete the test post to clean up
                    const data = await response.json();
                    if (data.id) {
                        await fetch(`${mastodonServer}/api/v1/statuses/${data.id}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${mastodonToken}` }
                        });
                    }
                }
            }

            let blueskySuccess = false;
            if (blueskyIdentifier && blueskyPassword) {
                showMessage('Testing Bluesky connection...', 'bg-blue-500 text-white');
                const session = await createBlueskySession(blueskyIdentifier, blueskyPassword);
                if (session && session.did) {
                    blueskySuccess = true;
                }
            }

            let rssSuccess = false;
            if (rssUrl) {
                showMessage('Testing RSS feed...', 'bg-blue-500 text-white');
                const feed = await fetchRssFeed(rssUrl);
                if (feed) {
                    rssSuccess = true;
                }
            }

            let messages = [];
            if (mastodonServer && mastodonToken) {
                messages.push(`Mastodon connection: ${mastodonSuccess ? 'SUCCESS' : 'FAILURE'}.`);
            }
            if (blueskyIdentifier && blueskyPassword) {
                messages.push(`Bluesky connection: ${blueskySuccess ? 'SUCCESS' : 'FAILURE'}.`);
            }
            if (rssUrl) {
                messages.push(`RSS feed check: ${rssSuccess ? 'SUCCESS' : 'FAILURE'}.`);
            }

            if (messages.length > 0) {
                const combinedMessage = messages.join(' ');
                const isOverallSuccess = messages.every(msg => msg.includes('SUCCESS'));
                showMessage(combinedMessage, isOverallSuccess ? 'bg-green-500 text-white' : 'bg-red-500 text-white');
            }
        });

        postBtn.addEventListener('click', async () => {
            const mastodonServer = mastodonServerInput.value.trim();
            const mastodonToken = mastodonTokenInput.value.trim();
            const blueskyIdentifier = blueskyIdentifierInput.value.trim();
            const blueskyPassword = blueskyPasswordInput.value.trim();
            const rssUrl = rssUrlInput.value.trim();

            if (!rssUrl) {
                showMessage('Please enter an RSS feed URL first.', 'bg-yellow-500 text-white');
                return;
            }

            showMessage('Fetching RSS feed...', 'bg-yellow-500 text-white');
            const feed = await fetchRssFeed(rssUrl);
            if (!feed) return;

            const items = feed.querySelectorAll('item');
            if (items.length === 0) {
                showMessage('No items found in RSS feed.', 'bg-yellow-500 text-white');
                return;
            }

            const latestItem = items[0];
            const title = latestItem.querySelector('title')?.textContent;
            const link = latestItem.querySelector('link')?.textContent;
            const description = latestItem.querySelector('description')?.textContent;

            if (!title || !link) {
                showMessage('Latest RSS item is missing a title or link.', 'bg-red-500 text-white');
                return;
            }

            const postText = `New Post: ${title}\n\nRead more here: ${link}`;

            let mastodonPosted = false;
            if (mastodonServer && mastodonToken) {
                showMessage('Posting to Mastodon...', 'bg-blue-500 text-white');
                mastodonPosted = await postToMastodon(mastodonServer, mastodonToken, postText);
            }

            let blueskyPosted = false;
            if (blueskyIdentifier && blueskyPassword) {
                showMessage('Posting to Bluesky...', 'bg-blue-500 text-white');
                const session = await createBlueskySession(blueskyIdentifier, blueskyPassword);
                if (session && session.accessJwt) {
                    blueskyPosted = await postToBluesky(postText, session.accessJwt);
                }
            }

            let messages = [];
            if (mastodonServer && mastodonToken) {
                messages.push(`Mastodon post: ${mastodonPosted ? 'SUCCESS' : 'FAILURE'}.`);
            }
            if (blueskyIdentifier && blueskyPassword) {
                messages.push(`Bluesky post: ${blueskyPosted ? 'SUCCESS' : 'FAILURE'}.`);
            }

            if (messages.length > 0) {
                const combinedMessage = messages.join(' ');
                const isOverallSuccess = messages.every(msg => msg.includes('SUCCESS'));
                showMessage(combinedMessage, isOverallSuccess ? 'bg-green-500 text-white' : 'bg-red-500 text-white');
            } else {
                showMessage('No social media accounts were configured.', 'bg-yellow-500 text-white');
            }
        });
    </script>
</body>
</html>
