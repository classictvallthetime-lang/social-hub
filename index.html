<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            max-width: 600px;
            margin: 2rem auto;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .chat-messages {
            height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="loadingIndicator" class="absolute inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-gray-200"></div>
    </div>

    <div class="chat-container bg-white p-6 md:p-8 flex flex-col h-[85vh]">
        <div id="username-display" class="bg-blue-600 text-white text-center py-2 px-4 rounded-t-xl text-lg font-semibold -m-6 md:-m-8 mb-6 md:mb-8">
            Your User ID: <span id="userIdDisplay">Loading...</span>
        </div>

        <div id="chat-messages" class="chat-messages flex-1 p-4 md:p-6 bg-gray-50 rounded-lg overflow-y-auto mb-4 border border-gray-200">
            <!-- Messages will be injected here -->
        </div>

        <form id="message-form" class="flex items-center space-x-2">
            <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200" required>
            <button type="submit" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition-colors duration-200 shadow-md">
                Send
            </button>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: This is a placeholder Firebase config.
        // It's a temporary workaround to make the app self-contained and runnable.
        const firebaseConfig = {
            apiKey: "mock-api-key",
            authDomain: "mock-auth-domain",
            projectId: "mock-project-id",
            storageBucket: "mock-storage-bucket",
            messagingSenderId: "mock-sender-id",
            appId: "mock-app-id"
        };
        
        // Use a mock app ID since we don't have the dynamic one
        const appId = 'classic-tv-all-the-time-lang';

        // ----------------------------------------------------
        // INITIALIZE FIREBASE AND AUTHENTICATION
        // ----------------------------------------------------
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;

        const loadingIndicator = document.getElementById('loadingIndicator');

        // Function to show the loading indicator
        function showLoading() {
            loadingIndicator.style.display = 'flex';
        }

        // Function to hide the loading indicator
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        // We use an asynchronous IIFE (Immediately Invoked Function Expression)
        // to handle Firebase authentication and data loading.
        (async () => {
            showLoading();
            try {
                // Sign in anonymously to get a user ID.
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
                console.log("Signed in with user ID:", userId);

                // Display the user ID
                const userIdDisplay = document.getElementById('userIdDisplay');
                if (userIdDisplay) {
                    userIdDisplay.textContent = userId;
                }

                // Check for existence of user document, and create if it doesn't exist
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'userData', 'profile');
                await setDoc(userDocRef, {
                    lastSeen: serverTimestamp()
                }, { merge: true });

                // ----------------------------------------------------
                // LISTEN FOR REAL-TIME CHAT MESSAGES
                // ----------------------------------------------------
                const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                const q = query(messagesCollectionRef, orderBy('createdAt'));
                
                onSnapshot(q, (snapshot) => {
                    const messagesList = document.getElementById('chat-messages');
                    messagesList.innerHTML = ''; // Clear existing messages
                    snapshot.forEach((doc) => {
                        const messageData = doc.data();
                        const isUserMessage = messageData.userId === userId;
                        const messageElement = document.createElement('div');
                        
                        // Use flexbox and Tailwind classes for message bubbles
                        messageElement.className = `flex mb-2 ${isUserMessage ? 'justify-end' : 'justify-start'}`;
                        
                        const bubble = document.createElement('div');
                        const bubbleClasses = isUserMessage
                            ? 'bg-blue-500 text-white rounded-xl py-2 px-4 shadow-md max-w-[80%]'
                            : 'bg-gray-300 text-gray-800 rounded-xl py-2 px-4 shadow-md max-w-[80%]';
                        bubble.className = bubbleClasses;
                        
                        const userNameElement = document.createElement('div');
                        userNameElement.className = `text-xs font-medium mb-1 ${isUserMessage ? 'text-right' : 'text-left'}`;
                        userNameElement.textContent = isUserMessage ? 'You' : `User: ${messageData.userId}`;
                        
                        const textElement = document.createElement('p');
                        textElement.textContent = messageData.text;

                        bubble.appendChild(userNameElement);
                        bubble.appendChild(textElement);
                        messageElement.appendChild(bubble);
                        messagesList.appendChild(messageElement);
                    });

                    // Scroll to the bottom to show the newest message
                    messagesList.scrollTop = messagesList.scrollHeight;
                });

                hideLoading();

            } catch (error) {
                console.error("Error during initialization:", error);
                document.body.innerHTML = `
                    <div class="absolute inset-0 bg-red-100 flex items-center justify-center text-red-700 text-center p-4">
                        <p>Error: Could not load the chat app. Please check the console for details.</p>
                    </div>
                `;
            }
        })();

        // ----------------------------------------------------
        // HANDLE MESSAGE SUBMISSION
        // ----------------------------------------------------
        const form = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '') return;

            if (userId) {
                try {
                    // Add a new document to the messages collection
                    const messagesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                    await addDoc(messagesCollectionRef, {
                        userId: userId,
                        text: text,
                        createdAt: serverTimestamp()
                    });
                    messageInput.value = ''; // Clear the input field
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            } else {
                console.error("User not authenticated.");
            }
        });
    </script>
</body>
</html>
